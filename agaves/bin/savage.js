(function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function g(){!a&&this.init&&this.init.apply(this,arguments)}var d=this.prototype;a=!0;var e=new this;a=!1;for(var f in c)e[f]=typeof c[f]=="function"&&typeof d[f]=="function"&&b.test(c[f])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);this._super=c;return e}}(f,c[f]):c[f];g.prototype=e,g.constructor=g,g.extend=arguments.callee;return g}})();var Savage={};typeof window=="undefined"&&(exports.Savage=Savage),Savage.error=function(a){console.log("SAVAGE ERROR: "+a)},Savage.debug=!0,Savage.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])},Savage.object=Class.extend({elements:[],cached:null,width:0,height:0,originalWidth:0,originalHeight:0,x:0,y:0,rotation:0,scaleX:1,scaleY:1,opacity:1,visible:!0,toDelete:!1,deleteMargin:1,destroy:!1,index:0,init:function(a){Savage.extend(this,a)},add:function(a){this.elements=this.elements.concat(a)},render:function(a){if(this.scaleX!=0&&this.scaleY!=0&&this.visible&&this.opacity!=0){a.save(),a.translate(this.x,this.y),a.scale(this.scaleX,this.scaleY),a.rotate(this.rotation);if(this.cached)a.translate(this.viewBox.x,this.viewBox.y),a.drawImage(this.cached,0,0);else for(var b=0,c=this.elements.length;b<c;b++){var d=this.elements[b];d.render(a)}a.restore()}},clone:function(){var a=Savage.extend({},this);a.d=Savage.extend({},{x:0,y:0,scaleX:0,scaleY:0,rotation:0});return a}}),Savage.utils={hexToRGBA:function(a,b){var c=parseInt(a.replace("#",""),16),d=c>>16&255,e=c>>8&255,f=c&255,g="rgba("+d+","+e+","+f+","+b+")";return g},hexToRGB:function(a){var b=parseInt(a.replace("#",""),16),c=b>>16&255,d=b>>8&255,e=b&255;return[c,d,e]}},Savage.Parser={parse:function(a){var b=a.getElementsByTagName("*"),c=this.parseElements(b),d=new Savage.object;d.add(c.elements),d.originalWidth=parseFloat(a.attributes.width.nodeValue),d.originalHeight=parseFloat(a.attributes.height.nodeValue),d.width=d.originalWidth,d.height=d.originalHeight;return d},parseElements:function(a){var b=[];for(var c=0;c<a.length;c++){var d=a[c],e=d.tagName.toLowerCase();if(e!="g"){var f=this.parseAttributes(d.attributes),g=new Savage[e](f);b.push(g)}}return{elements:b,hitmap:hitmap,center:center}},parseElement:function(a){var b=a.tagName.toLowerCase(),c=this.parseAttributes(a.attributes),d=new Savage[b](c);d.id=a.id;return d},parseAttributes:function(a){var b={};for(var c=0;c<a.length;c++){var d=a[c].nodeName,e=a[c].nodeValue;this.attributeMap[d]&&(d=this.attributeMap[d]);var f=this.attributeTypesMap[d];this.parseAttribute[f]&&(b[d]=this.parseAttribute[f](e))}return b},attributeMap:{cx:"x",cy:"y",r:"radius",d:"commands","stroke-width":"strokeWidth"},attributeTypes:{"width,height,x,y":"float","rx,ry,radius,opacity,strokeWidth":"float","fill,stroke":"color",transform:"transform",commands:"d",points:"points",id:"string"},attributeTypesMap:null,parseAttributeTypesMap:function(){if(this.attributeTypesMap==null){this.attributeTypesMap={};for(var a in this.attributeTypes)if(this.attributeTypes.hasOwnProperty(a)){var b=a.split(","),c=this.attributeTypes[a];for(var d in b)b.hasOwnProperty(d)&&(this.attributeTypesMap[b[d]]=c)}}},parseAttribute:{string:function(a){return a},color:function(a){if(a=="none")return null;return a},"float":function(a){return parseFloat(a)},"int":function(a){return parseInt(a)},transform:function(a){a=a.replace(/\,/g,"");var b=a.match(/matrix\(([0-9\-\.\s]+)\)/);if(b){var c=b[1].split(" ");for(var d=0,e=c.length;d<e;d++)c[d]=parseFloat(c[d]);return c}Savage.error("transform command not implemented");return null},d:function(a){function g(c){switch(c){case"M":e=parseFloat(a.shift()),f=parseFloat(a.shift()),b.push({type:"m",data:{x:e,y:f}}),d=c;break;case"h":e+=parseFloat(a.shift()),b.push({type:"l",data:{x:e,y:f}}),d=c;break;case"H":e=parseFloat(a.shift()),b.push({type:"l",data:{x:e,y:f}}),d=c;break;case"v":f+=parseFloat(a.shift()),b.push({type:"l",data:{x:e,y:f}}),d=c;break;case"V":f=parseFloat(a.shift()),b.push({type:"l",data:{x:e,y:f}}),d=c;break;case"l":e+=parseFloat(a.shift()),f+=parseFloat(a.shift()),b.push({type:"l",data:{x:e,y:f}}),d=c;break;case"L":e=parseFloat(a.shift()),f=parseFloat(a.shift()),b.push({type:"l",data:{x:e,y:f}}),d=c;break;case"c":var h={x:e+parseFloat(a.shift()),y:f+parseFloat(a.shift()),x2:e+parseFloat(a.shift()),y2:f+parseFloat(a.shift()),x3:e+parseFloat(a.shift()),y3:f+parseFloat(a.shift())};b.push({type:"c",data:h}),e=h.x3,f=h.y3,d=c;break;case"C":var h={x:parseFloat(a.shift()),y:parseFloat(a.shift()),x2:parseFloat(a.shift()),y2:parseFloat(a.shift()),x3:parseFloat(a.shift()),y3:parseFloat(a.shift())};b.push({type:"c",data:h}),e=h.x3,f=h.y3,d=c;break;case"s":var i=b[b.length-1];if("cCsS".indexOf(i.type)!=-1){var h={x:e+e-i.data.x2,y:f+f-i.data.y2,x2:e+parseFloat(a.shift()),y2:f+parseFloat(a.shift()),x3:e+parseFloat(a.shift()),y3:f+parseFloat(a.shift())};b.push({type:"c",data:h}),e=h.x3,f=h.y3,d=c}else Savage.error("previous command not a bezier");break;case"S":var i=b[b.length-1];if("cCsS".indexOf(i.type)!=-1){var h={x:e+e-i.data.x2,y:f+f-i.data.y2,x2:parseFloat(a.shift()),y2:parseFloat(a.shift()),x3:parseFloat(a.shift()),y3:parseFloat(a.shift())};b.push({type:"c",data:h}),e=h.x3,f=h.y3,d=c}else Savage.error("previous command not a bezier");break;case"z":break;default:a.unshift(c),g(d)}}a=Savage.Parser.pathToArray_d(a);var b=[],c=null,d=null,e=0,f=0;while(c=a.shift())g(c);return b},points:function(a){a=Savage.Parser.pathToArray_points(a);var b=[],c=0,d=0;while(c=a.shift())d=a.shift(),b.push({x:parseFloat(c),y:parseFloat(d)});return b}},pathToArray_points:function(a){var b=a.replace(/[\n\t]/g,"").replace(/\s/g,",").replace(/\-/,",-").replace(/\,+/g,",").replace(/^\,|\,$/g,"").split(",");return b},pathToArray_d:function(a){var b=a.replace(/[\n\t\-\smlhvcszqta]/gmi,function(a){var b=","+a+",";switch(a){case"\t":case"\n":b="";break;case" ":b=",";break;case"-":b=",-"}return b}).replace(/\,+/g,",").replace(/^\,|\,$/g,"").split(",");return b},pointsToBox:function(a){var b={x:null,y:null,x2:null,y2:null,width:null,height:null};for(var c=1,d=a.length;c<d;c++){var e=a[c];if(e.x<b.x||b.x==null)b.x=e.x;if(e.x>b.x2||b.x2==null)b.x2=e.x;if(e.y<b.y||b.y==null)b.y=e.y;if(e.y>b.y2||b.y2==null)b.y2=e.y}b.width=b.x2-b.x,b.height=b.y2-b.y;return b}},Savage.Parser.parseAttributeTypesMap(),Savage.element=Class.extend({id:"",fill:"#000000",stroke:null,strokeWidth:0,opacity:1,transform:null,x:0,y:0,width:0,height:0,init:function(a){Savage.extend(this,a)},_doTransform:function(a){this.transform&&a.transform(this.transform[0],this.transform[1],this.transform[2],this.transform[3],this.transform[4],this.transform[5])},_fillAndStroke:function(a){this.fill&&(this.fill.indexOf("#")!=-1?a.fillStyle=Savage.utils.hexToRGBA(this.fill,this.opacity):a.fillStyle=this.fill,a.fill()),this.stroke&&(a.lineWidth=this.strokeWidth,a.strokeStyle=this.stroke,a.stroke())},clone:function(){return Savage.extend({},this)}}),Savage.circle=Savage.element.extend({type:"circle",init:function(a){this._super(a)},translate:function(a,b){this.x+=a,this.y+=b},render:function(a){a.save(),a.beginPath(),this._doTransform(a),a.arc(this.x,this.y,this.radius,Math.PI*2,!1),this._fillAndStroke(a),a.restore()},radius:0}),Savage.ellipse=Savage.element.extend({type:"ellipse",init:function(a){this._super(a)},render:function(a){a.save(),a.beginPath(),this._doTransform(a);var b=this.ry/this.rx;a.translate(0,this.y),a.scale(1,b),a.translate(0,-this.y),a.arc(this.x,this.y,this.rx,Math.PI*2,!1),this._fillAndStroke(a),a.restore()},rx:0,ry:0}),Savage.path=Savage.element.extend({type:"path",init:function(a){this._super(a)},render:function(a){a.save(),a.beginPath(),this._doTransform(a);for(var b=0,c=this.commands.length;b<c;b++){var d=this.commands[b];switch(d.type){case"m":a.moveTo(d.data.x,d.data.y);break;case"l":a.lineTo(d.data.x,d.data.y);break;case"c":a.bezierCurveTo(d.data.x,d.data.y,d.data.x2,d.data.y2,d.data.x3,d.data.y3)}}a.closePath(),this._fillAndStroke(a),a.restore()},commands:[]}),Savage.polygon=Savage.element.extend({type:"polygon",points:[],init:function(a){this._super(a)},translate:function(a,b){for(var c=1,d=this.points.length;c<d;c++)this.points[c].x+=a,this.points[c].y+=b},render:function(a){a.save(),a.beginPath(),this._doTransform(a),a.moveTo(this.points[0].x,this.points[0].y);for(var b=1,c=this.points.length;b<c;b++)a.lineTo(this.points[b].x,this.points[b].y);a.closePath(),this._fillAndStroke(a),a.restore()}}),Savage.polyline=Savage.element.extend({type:"polyline",points:[],init:function(a){this._super(a)},translate:function(a,b){for(var c=1,d=this.points.length;c<d;c++)this.points[c].x+=a,this.points[c].y+=b},render:function(a){console.log("ERROR: method not implemented: Savage.polyline.render()")}}),Savage.rect=Savage.element.extend({type:"rect",rx:0,ry:0,init:function(a){this._super(a)},translate:function(a,b){this.x+=a,this.y+=b},render:function(a){a.save(),a.beginPath(),this._doTransform(a),this.rx==0||this.ry==0?(a.moveTo(this.x,this.y),a.lineTo(this.x+this.width,this.y),a.lineTo(this.x+this.width,this.y+this.height),a.lineTo(this.x,this.y+this.height),a.lineTo(this.x,this.y)):(a.moveTo(this.x+this.rx,this.y),a.lineTo(this.x+this.width-this.rx,this.y),a.bezierCurveTo(this.x+this.width,this.y,this.x+this.width,this.y+this.ry,this.x+this.width,this.y+this.ry),a.lineTo(this.x+this.width,this.y+this.height-this.ry),a.bezierCurveTo(this.x+this.width,this.y+this.height,this.x+this.width-this.rx,this.y+this.height,this.x+this.width-this.rx,this.y+this.height),a.lineTo(this.x+this.rx,this.y+this.height),a.bezierCurveTo(this.x,this.y+this.height,this.x,this.y+this.height-this.ry,this.x,this.y+this.height-this.ry),a.lineTo(this.x,this.y+this.ry),a.bezierCurveTo(this.x,this.y,this.x+this.rx,this.y,this.x+this.rx,this.y)),a.closePath(),this._fillAndStroke(a),a.restore()}})